<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout Page</title>
  <meta charset="UTF-8">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    body {

     
      background-color: #232323;
      background-repeat: no-repeat;
      background-size: cover;
      margin: 0px 40px 50px 40px ;
      color: #fff;

    }




    #navbar1 {
      background-color: #00000060 !important;
   
  
      margin: 0px -40px -0px -40px ;
      font-family: 'DotGothic16', sans-serif;
    }

    .navbar-brand {
      color: white;
      font-weight: 900;
    }

    .navbar-brand:hover {
      color: rgb(0, 0, 0);
    }

    .navbar-nav {
      margin-left: auto;
    }

    .nav-item {
      padding: 0 15px;
    }

    .navbar-toggler {
      border: none;
      outline: none;
    }

    .navbar-toggler-icon {
      background-color: rgb(0, 0, 0);
    }

    @media (max-width: 767px) {
      .navbar-collapse {
        justify-content: center;
      }
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      margin-right: -15px;
      margin-left: -15px;
    }

    #col1 {
      color: #ffffff;
      padding: 50px;
      background-color: #232323;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(255, 231, 231, 0.1);

      margin-bottom: 20px;


    }

    #col1 input[type="radio"]:disabled+label {
      font-style: italic;
    }

    #col1 label:hover {
      cursor: pointer;

    }


    .address-card {
      border: 1px solid #6f6f6f;
      border-radius: 5%;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #232323;
    width: 100%;
      align-self: center;
    }

    .address-card p {
      margin: 5px;
    }

    .address-card p b {
      color: #f90;
    }

    .btn {

      margin-right: 10px;
    }

    #payment {

      border: 20px;
      border-color: #fff;
      align-self: auto;

    }

    #buttons {
      display: grid;
      justify-content: center;
      margin-top: 20px;
      grid-gap: 10px;

    }

    .cart-item {

      padding: 10px;
      margin-bottom: 10px;
      background-color: #2b2b2b;
      max-width: 600px;
    }

    .cart-item p {
      margin: 5px;
    }

    .cart-item p b {
      color: #f90;
    }

    .payment {
      margin: 50px;
      padding:100px;
    }
.larger-button {
  width: 150px; 
  height: 40px; 
}
#hero{
  margin-top: 40px;
}

  </style>
</head>

<body>
  


  <nav class="navbar navbar-expand-lg navbar-dark bg-dark" id="navbar1">
    
    <div class="container">
  
            <ul class="navbar-nav ml-auto">
              <li class="nav-item">
                
              </li>
                <li class="nav-item">
                    <a class="nav-link" href="wishlist"><i class="fas fa-heart"></i></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="cart"><i class="fas fa-shopping-cart"></i></a>
                </li>
                
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-user"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                        <% if (user) { %>
                        <a class="dropdown-item" href="account"><%= user.username %></a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="orders">
                          my Orders
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="logout">X Log Out X</a>
                        

                        <% } else { %>
                        <a class="dropdown-item" href="login">Sign In</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="signup">Sign Up</a>
                        <% } %>
                    </div>
                </li>
            </ul>
        </div>
    </div>
  </nav>

 
  <div class="row" style=" background-color: #00000058; padding: 20px; border-radius: 17px " id="hero">

 
      <div class="col-md-12">
        <h4 class="mb-3" style="font-family: 'DotGothic16', sans-serif; color: #f90;">Saved Addresses:</h4>
        <table class="table table-dark table-hover table">
          <thead>
            <tr>
              <th>Select</th>
              <th>Name</th>
              <th>Residential Address</th>
              <th>Landmark</th>
              <th>City</th>
              <th>State</th>
              <th>ZIP Code</th>
              <th>Edit</th>                                           
            </tr>
          </thead>
          <tbody>
            <% if (!addressData) { %>
              <tr>
                <td colspan="8">
                  <h1 style="font-family: 'DotGothic16', sans-serif; color: #f90;">Add Address</h1>
                </td>
              </tr>
            <% } else { %>
              <% addressData.addresses.forEach(address => { %>
                <tr><div id="radioContainer">
                  <td>
                    <input type="radio" name="selectedAddress" data-address-id="<%= address._id %>" <%= address.default ? 'checked' : '' %>>
                  </td>
                </div>
                  <td><%= address.fullname %></td>
                  <td><%= address.house %></td>
                  <td><%= address.landmark %></td>
                  <td><%= address.city %></td>
                  <td><%= address.state %></td>
                  <td><%= address.zip %></td>
                  <td>
                    <a href="editaddress?address=<%= address._id %>&account=1" class="btn btn-outline-success">Edit</a>
                  </td>
                </tr>
              <% }); %>
            <% } %>
          </tbody>
        </table>
        <div id="buttons" class="mt-4">
          <a href="address" class="btn btn-outline-light me-3">Add Address</a>
        </div>
        
      </div>
      
      <div class="col-md-6" >
        <h4 class="mb-3" style="font-family: 'DotGothic16', sans-serif; color: #f90;">Your Cart:</h4>
        <% if (cartItems.length) { %>
          <table class="table table-dark table-hover" >
            <thead>
              <tr>
                <th>Product Name</th>
                <th>Price</th>
                <th>Quantity</th>
              </tr>
            </thead>
            <tbody>
              <% cartItems.forEach((cart)=> { %>
      
                <% cart.products.forEach((product, index)=> { %>
                  <tr>
                    <td><%= product.productId.productName %></td>
                    <% if (product.productId.offerPrice !== 0 || product.productId.catofferPrice !== 0) { %>
                      <td class="price">
                        <% if (product.productId.offerPrice > 0 && product.productId.catofferPrice > 0) { %>
                          <% if (product.productId.offerPrice > product.productId.catofferPrice) { %>
                            <%= product.productId.catofferPrice %>
                          <% } else if (product.productId.offerPrice < product.productId.catofferPrice) { %>
                            <%= product.productId.offerPrice %>
                          <% } %>
                        <% } else if (product.productId.offerPrice > 0) { %>
                          <%= product.productId.offerPrice %>
                        <% } else if (product.productId.catofferPrice > 0) { %>
                          <%= product.productId.catofferPrice %>
                        <% } %>
                      </td>
                    <% } else { %>
                      <td class="price">
                        <%= product.productId.productPrice %>
                      </td>
                    <% } %>
                    <td><%= product.quantity%></td>
                  </tr>
                  <% }); %>
                  <% }); %>
                </tbody>
              </table>
              <% cartItems.forEach((cart)=> { %>
              <h4 style="color: #ffffff; background-color: rgba(0, 0, 0, 0.49); width: fit-content; padding: 10px; border-radius: 17px;">Total Price: ₹<%= cart.totalAmount.toFixed(2) %></h4>

              <% }); %>
              
                <% if (cartItems.cartOffer=== true) { %>
              
              <button
              type="button"
              class="btn btn-primary col-md-6 m-1 larger-button" 
              data-toggle="modal"
              data-target="#addCouponModal"
            >
             Coupon Applied
            </button>
            <% }else{ %>
              
              <button
              type="button"
              class="btn btn-outline-primary col-md-6 m-1 larger-button" 
              data-toggle="modal"
              data-target="#addCouponModal"
            >
              Coupons
            </button>
              
              <% } %>

            <div
              class="modal fade"
              id="addCouponModal"
              tabindex="-1"
              role="dialog"
              aria-labelledby="addCouponModalLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="addCouponModalLabel">Add Coupon</h5>
                    <button
                      type="button"
                      class="close"
                      data-dismiss="modal"
                      aria-label="Close"
                    >
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <% cartItems.forEach(function(cartItem) { %>
                  <div class="modal-body">
                    <form id="couponForm" action="/checkCoupon" method="POST">
                      <div class="form-group text-dark">
                        <label for="couponCode">Coupons</label>
                        <% if (coupons) { %>
                          
                          <% coupons.forEach(coupon => { %>
                            Code:  <span class="text-warning"> <%=coupon.couponCode%> </span>
                         
                            Discount:  <span class="text-warning"> ₹<%= coupon.discountAmount%> </span><br>
                            On Orders Above: <span class="text-warning"> ₹<%= coupon.priceRange%> </span><br>
                            Expires On:  <span class="text-warning"> <%= coupon.expirationDate.toLocaleString() %> </span><br><br>
                            <% }); %>
                            <% } else { %>
                              No Coupons Available
                              <% } %>
                              
                            </div>
                            <% if (cartItem.cartOffer===true) { %>
                              <button type="submit" class="btn btn-outline-success"  disabled>
                                Coupon Applied
                              </button>
                             
                            <% } else {%>
                    
                            <button type="submit" class="btn btn-outline-primary">
                              Apply Coupon
                            </button>
                            <% } %>
                            <input
                            type="text"
                            class="form-control"
                            id="couponCode"
                            name="couponCode"
                            placeholder="Enter coupon code"
                            required
                            />
                            <input
                            type="hidden"
                            name="totalPrice"
                            value="<%= cartItem.totalAmount %>"
                            />
                          </form>
                  </div>
                  <% }) %>
                </div>
              </div>
            </div>
            
          </div>
        <% } else { %>
          <p>Your cart is empty.</p>
        <% } %>
        <div class="payment" style="background-color: #0000007e; width: fit-content; padding: 10px; border-radius: 17px; margin-right: 20px;">
          <h4 class="mb-3">Payment Options:</h4>
          <div class="mb-3">
            <label class="d-flex align-items-center">
              <input type="radio" name="paymentMethod" value="cod">
              <span class="ms-2">Cash On Delivery</span>
            </label>
          </div>
          <div class="mb-3">
            <label class="d-flex align-items-center">
              <input type="radio" name="paymentMethod" value="razorpay">
              <span class="ms-2">Online Payment</span>
            </label>
            <label class="d-flex align-items-center">
              <input type="radio" name="paymentMethod" value="wallet">
              <span class="ms-2">Wallet</span>
            </label>
            <div id="walletCard" class="card" style="display: none ;background-color: #ffffff7e; width: fit-content; padding: 10px; border-radius: 17px; font-family: 'DotGothic16', sans-serif; color:#ffffff">
              <% if (wallet) { %>
                <span>Balance:<%= wallet.wallet  %></span>
               
              <% } else{%>
          <span> Wallet Not Found!!</span>
          <%}  %>
              </div>
          </div>
          <button id="orderButton" type="submit" class="btn btn-outline-warning"
              onclick="placeOrderHandler()">
              Confirm Order
            </button>
        </div>
        
      </div>
    </div>
    

                         
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>



  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
   
   
</script>




  <script>
   
new ClipboardJS('.copy-button');


document.querySelectorAll('.copy-button').forEach(function (btn) {
    btn.addEventListener('click', function () {
        var tooltip = document.createElement('span');
        tooltip.className = 'tooltip';
        tooltip.textContent = 'Copied!';
        this.appendChild(tooltip);
        setTimeout(function () {
            tooltip.parentElement.removeChild(tooltip);
        }, 1000);
    });
});

</script>

  <script>
    $(document).ready(function () {
      $("#couponForm").submit(function (event) {
        event.preventDefault();
        var formData = $(this).serialize();
  
        $.ajax({
          url: "/checkCoupon",
          type: "POST",
          data: formData,
          success: function (response) {
            toastr.success('Coupon Added!', 'Success');
            location.reload();
          },
          error: function (error) {
            toastr.error('Error adding coupon!. Are you sure you havent used this coupon yet?.', 'Error');
            console.error(error);
          },
        });
      });
    });
  </script>


<script>
  const walletRadioButton = document.querySelector('input[name="paymentMethod"][value="wallet"]');
  const walletCard = document.getElementById('walletCard');

  function hideWalletCard() {
      walletCard.style.display = 'none';
  }

  function showWalletCard() {
      const walletBalance = <%= wallet ? wallet.wallet.toFixed(2) : 0 %>;
      const totalAmount = <%= cartItems.length ? cartItems[0].totalAmount.toFixed(2) : 0 %>;
    
      if (walletBalance < totalAmount) {
          walletCard.style.display = 'block';
          walletCard.innerHTML =  'Wallet balance: ₹'+' ' + '<span style = "color: gold">'+ walletBalance.toFixed(2) + '</span><span style="color: red;"><br>Insufficient balance for this purchase.</span>';
          walletCard.style.backgroundColor = '#00000058';
      } else {
          walletCard.style.display = 'block';
          walletCard.innerHTML =  'Wallet balance: ₹'+' ' + '<span style = "color: gold">'+ walletBalance.toFixed(2) + '</span>';
          walletCard.style.backgroundColor = '#00000058'; 
      }
  }

  walletRadioButton.addEventListener('change', function () {
      if (this.checked) {
          showWalletCard();
      } else {
          hideWalletCard();
      }
  });

  const otherPaymentMethod1 = document.querySelector('input[name="paymentMethod"][value="razorpay"]');
  const otherPaymentMethod2 = document.querySelector('input[name="paymentMethod"][value="cod"]');
  
  otherPaymentMethod1.addEventListener('change', hideWalletCard);
  otherPaymentMethod2.addEventListener('change', hideWalletCard);
</script>


  <script>
    $("#checkout-form").submit((e) => {
      e.preventDefault();
      $("#orderButton").prop("disabled", true);
      const formData = $("#checkout-form").serializeArray();
      $.ajax({
        url: "/order",
        method: "post",
        data: formData,

        success: (response) => {
          console.log(response);
          if (response.codSuccess) {
            console.log("Redirecting to home now");

          }
        },
        error: function (xhr, textStatus, errorThrown) {
          console.log("Error:", errorThrown);
        },
      });
    });

    





    const radioButtons = document.querySelectorAll('input[type="radio"][name="selectedAddress"]');

    let addressId;

    radioButtons.forEach(radio => {
      radio.addEventListener('change', async () => {
        if (radio.checked) {
          addressId = radio.getAttribute('data-address-id');
          try {
            const response = await fetch('/updateDefaultAddress', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ addressId }),
            });
            const data = await response.json();
            if (data.success) {
            }
          } catch (error) {
            console.error('Error updating default address', error);
          }
        }          
      });
    });

    async function placeOrderHandler() {
      let paymentMethod;
      const paymentOptionNodeList = document.querySelectorAll('input[type="radio"][name="paymentMethod"]');
      paymentOptionNodeList.forEach((paymentSelector) => {
        if (paymentSelector.checked) {
          paymentMethod = paymentSelector.value;
        }
      });

      if (paymentMethod && addressId) {
        try {
          const response = await fetch("/order", 
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ addressId, paymentMethod }),
          });

      
          const responseData = await response.json();
          
       

          if (paymentMethod === "razorpay") {
            razorpayPayment(responseData.newOrder, responseData.order,responseData.totalAmount);
          }
            
           
          

         else if (response.ok) {
            toastr.success('Order placed successfully!', 'Success');
            setTimeout(function() {
             window.location.href = '/ordersuccess'; 
           }, 1500); 
          
        
          } else {
            toastr.error('Error placing order. Please try again later.', 'Error');
          }
        } catch (error) {
          console.error(error);
          toastr.error('Error placing order. Please try again later.', 'Error');
        }
      }else{
        toastr.warning('Please Select Address and Payment Method', 'Warning');
      }

     

    }


    function razorpayPayment(newOrder,order,price){
     
      var options = {
        key: "rzp_test_T7Y9hT7EceVVNL",
        amount: price,
        currency: "INR",
        name: "Cyborg Gaming",
        description: "Test Transaction",
        image: "https://example.com/your_logo",
        order_id: newOrder.id,
        handler: function (response) {
        
         
           verifyPayment(newOrder,order, price,response);
    
        } ,
    "prefill": {
        "name": "Gaurav Kumar",
        "email": "gaurav.kumar@example.com",
        "contact": "9000090000"
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    }
};
var rzp1 = new Razorpay(options);
rzp1.on('payment.failed', function (response){
        alert(response.error.code);
        alert(response.error.description);
        alert(response.error.source);
        alert(response.error.step);
        alert(response.error.reason);
        alert(response.error.metadata.order_id);
        alert(response.error.metadata.payment_id);
});

    rzp1.open();

    }


    

    function verifyPayment(newOrder,order, price, response) {
     
      $.ajax({
        url: "/verify-payment",
        data: {
          response,
         newOrder,
          order,
          price,
        },
        method: "post",
        success: (response) => {
          if (response.status) {
            toastr.success('paid successfully!', 'Success');
            window.location.href = '/ordersuccess'
          } else {
            toastr.error('payment failed. Please try again later.', 'Error');
          }
        },
      });
    }


  </script>
</body>

</html>