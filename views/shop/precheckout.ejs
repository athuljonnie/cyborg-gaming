<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout Page</title>
  <meta charset="UTF-8">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <!-- Custom CSS -->

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    body {

      background-image: url('/shop/img/8481.jpg');
      background-repeat: no-repeat;
      background-size: cover;
      margin: 50px;
      color: #fff;

    }




    #navbar1 {
      background-color: #000000 !important;

      font-family: 'DotGothic16', sans-serif;
    }

    .navbar-brand {
      color: white;
      font-weight: 900;
    }

    .navbar-brand:hover {
      color: white;
    }

    .navbar-nav {
      margin-left: auto;
    }

    .nav-item {
      padding: 0 15px;
    }

    .navbar-toggler {
      border: none;
      outline: none;
    }

    .navbar-toggler-icon {
      background-color: rgb(0, 0, 0);
    }

    @media (max-width: 767px) {
      .navbar-collapse {
        justify-content: center;
      }
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      margin-right: -15px;
      margin-left: -15px;
    }

    #col1 {
      color: #ffffff;
      padding: 50px;
      background-color: #232323;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(255, 231, 231, 0.1);

      margin-bottom: 20px;


    }

    #col1 input[type="radio"]:disabled+label {
      font-style: italic;
    }

    #col1 label:hover {
      cursor: pointer;

    }


    .address-card {
      border: 1px solid #6f6f6f;
      border-radius: 5%;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #232323;
      max-width: 300px;
      align-self: center;
    }

    .address-card p {
      margin: 5px;
    }

    .address-card p b {
      color: #f90;
      /* Custom color for bold text (e.g., Name, Residential Address, etc.) */
    }

    .btn {

      margin-right: 10px;
      /* Add some space between buttons */
    }

    #payment {

      border: 20px;
      border-color: #fff;
      align-self: auto;

    }

    #buttons {
      display: grid;
      justify-content: center;
      margin-top: 20px;
      grid-gap: 10px;

    }

    .cart-item {

      padding: 10px;
      margin-bottom: 10px;
      background-color: #2b2b2b;
      max-width: 600px;
    }

    .cart-item p {
      margin: 5px;
    }

    .cart-item p b {
      color: #f90;
    }

    .payment {
      margin: 50px;
    }
    
    
    /* Other styles... */
  </style>
</head>

<body>
  



 
    <div class="row"  style=" background-color: #0000007e; padding: 20px; border-radius: 17px ">
      <!-- Saved Addresses Table -->
 
      <div class="col-md-6">
        <h4 class="mb-3" style="font-family: 'DotGothic16', sans-serif; color: #f90;">Saved Addresses:</h4>
        <table class="table table-dark table-hover">
          <thead>
            <tr>
              <th>Select</th>
              <th>Name</th>
              <th>Residential Address</th>
              <th>Landmark</th>
              <th>City</th>
              <th>State</th>
              <th>ZIP Code</th>
              <th>Edit</th>
            </tr>
          </thead>
          <tbody>
            <% if (!addressData) { %>
              <tr>
                <td colspan="8">
                  <h1 style="font-family: 'DotGothic16', sans-serif; color: #f90;">Add Address</h1>
                </td>
              </tr>
            <% } else { %>
              <% addressData.addresses.forEach(address => { %>
                <tr>
                  <td>
                    <input type="radio" name="selectedAddress" data-address-id="<%= address._id %>" <%= address.default ? 'checked' : '' %>>
                  </td>
                  <td><%= address.fullname %></td>
                  <td><%= address.house %></td>
                  <td><%= address.landmark %></td>
                  <td><%= address.city %></td>
                  <td><%= address.state %></td>
                  <td><%= address.zip %></td>
                  <td>
                    <a href="editaddress?address=<%= address._id %>&account=1" class="btn btn-outline-success">Edit</a>
                  </td>
                </tr>
              <% }); %>
            <% } %>
          </tbody>
        </table>
        <div id="buttons" class="mt-4">
          <a href="address" class="btn btn-outline-light me-3">Add Address</a>
          <!-- Proceed to Payment Button -->
        </div>
        
      </div>
      
      <!-- Cart Table -->
      <div class="col-md-6" >
        <h4 class="mb-3" style="font-family: 'DotGothic16', sans-serif; color: #f90;">Your Cart:</h4>
        <% if (cartItems.length) { %>
          <table class="table table-dark table-hover" >
            <thead>
              <tr>
                <th>Product Name</th>
                <th>Price</th>
                <th>Quantity</th>
              </tr>
            </thead>
            <tbody>
              <% cartItems.forEach((cart)=> { %>
      
                <% cart.products.forEach((item, index)=> { %>
                  <tr>
                    <td><%= item.productId.productName %></td>
                    <td><%= item.productId.productPrice %></td>
                    <td><%= item.quantity%></td>
                  </tr>
                  <% }); %>
                  <% }); %>
                </tbody>
              </table>
              <% cartItems.forEach((cart)=> { %>
              <h4 style="color: #ffffff; background-color: rgba(0, 0, 0, 0.49); width: fit-content; padding: 10px; border-radius: 17px;">Total Price: â‚¹<%= cart.totalAmount.toFixed(2) %></h4>

              <% }); %>
          <div id="buttons" class="mt-4">
            <button id="orderButton" type="submit" class="btn btn-outline-warning"
              onclick="placeOrderHandler()">
              Confirm Order
            </button>
          </div>
        <% } else { %>
          <p>Your cart is empty.</p>
        <% } %>
        <div class="payment" style="background-color: #0000007e; width: fit-content; padding: 10px; border-radius: 17px;">
          <h4 class="mb-3">Payment Options:</h4>
          <!-- Your payment options content here -->
          <div class="mb-3">
            <label class="d-flex align-items-center">
              <input type="radio" name="paymentMethod" value="cod">
              <span class="ms-2">Cash On Delivery</span>
            </label>
          </div>
          <div class="mb-3">
            <label class="d-flex align-items-center">
              <input type="radio" name="paymentMethod" value="razorpay">
              <span class="ms-2">Online Payment</span>
            </label>
          </div>
        </div>
      </div>
      
    </div>
    

                         
  </div>


  <!-- Bootstrap JS (Optional) -->
  <!-- Bootstrap JS (optional if you need to add JavaScript functionality) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>


  <script>
    $("#checkout-form").submit((e) => {
      e.preventDefault();
      $("#orderButton").prop("disabled", true);
      const formData = $("#checkout-form").serializeArray();
      $.ajax({
        url: "/order",
        method: "post",
        data: formData,

        success: (response) => {
          console.log(response, "responseðŸ˜ŠðŸ˜ŠðŸ˜ŠðŸ²ðŸ²ðŸ²ðŸ²ðŸ²ðŸ˜Š");
          if (response.codSuccess) {
            console.log("Redirecting to home now");

          }
        },
        error: function (xhr, textStatus, errorThrown) {
          console.log("Error:", errorThrown);
        },
      });
    });

    const radioButtons = document.querySelectorAll('input[type="radio"][name="selectedAddress"]');

    let addressId;

    radioButtons.forEach(radio => {
      radio.addEventListener('change', async () => {
        if (radio.checked) {
          addressId = radio.getAttribute('data-address-id');
          try {
            const response = await fetch('/updateDefaultAddress', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ addressId }),
            });
            const data = await response.json();
            if (data.success) {
              console.log('Default address updated');
            }
          } catch (error) {
            console.error('Error updating default address', error);
          }
        }
      });
    });

    async function placeOrderHandler() {
      let paymentMethod;
      const paymentOptionNodeList = document.querySelectorAll('input[type="radio"][name="paymentMethod"]');
      paymentOptionNodeList.forEach((paymentSelector) => {
        if (paymentSelector.checked) {
          paymentMethod = paymentSelector.value;
        }
      });

      if (paymentMethod && addressId) {
        try {
          const response = await fetch("/order", 
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ addressId, paymentMethod }),
          });

          const responseData = await response.json(); // Parse response JSON data
          console.log(responseData);
          console.log(paymentMethod);
          console.log(responseData.order, "â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸---> order", responseData.newOrder, "ðŸ«‚ðŸ«‚ðŸ«‚ðŸ«‚------------> new order we created");

          if (paymentMethod === "razorpay") {
            razorpayPayment(responseData.order, responseData.newOrder, responseData.price);
          }

          if (response.ok) {
            toastr.success('Order placed successfully!', 'Success');
          } else {
            toastr.error('Error placing order. Please try again later.', 'Error');
          }
        } catch (error) {
          console.error(error);
          toastr.error('Error placing order. Please try again later.', 'Error');
        }
      }

    }


    function razorpayPayment(order, newOrder, price) {
      console.log(order, newOrder, price, "--------------------------------------------------->>>>>ðŸ˜");
      console.log("razor function");
      var options = {
        key: "rzp_test_T7Y9hT7EceVVNL",
        amount: order.amount,
        currency: "INR",
        name: "Cyborg Gaming",
        description: "Test Transaction",
        image: "https://example.com/your_logo",
        order_id: order.id,
        handler: function (response) {
          console.log("Handler function executed");
          console.log("Response:", response);

          try {
            verifyPayment(response, order, newOrder, price);
          } catch (error) {
            console.error("Error in verifyPayment:", error);
          }
        },

        prefill: {
          name: "User",
          email: "user@example.com",
          contact: "000000000",
        },
        notes: {
          address: "Razorpay Corporate Office",
        },
        theme: {
          color: "#243247",
        },
      };
      console.log(options, "ðŸ¤·â€â™€ï¸ðŸ¤·â€â™€ï¸ðŸ¤·â€â™€ï¸");
      var rzp1 = new Razorpay(options);

      rzp1.on("payment.failed", function (response) {
        console.log("ðŸ’•ðŸ’•ðŸ’•ðŸ’•ðŸ’•");
        console.log(response);
        verifyPayment(response, order);
      });
      rzp1.open();
    }

    function verifyPayment(payment, order, newOrder, price) {
      console.log("verifying payment" , payment , order , newOrder ,price);
      console.log(newOrder, price);
      $.ajax({
        url: "/verify-payment",
        data: {
          payment,
          order,
          newOrder,
          price,
        },
        method: "post",
        success: (response) => {
          if (response.status) {
            toastr.success('paid successfully!', 'Success');
          } else {
            toastr.error('payment failed. Please try again later.', 'Error');
          }
        },
      });
    }


  </script>
</body>

</html>