<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Cart</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <!-- Custom CSS -->
  
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body {

      background-color: #151313;
      color: rgb(0, 0, 0);
    }

    .product-img {
      max-width: 100%;
      height: auto;
    }

    .btn-group {
      display: flex;
      gap: 10px;
    }

    

        #navbar1 {
            background-color: #000000 !important;
            /* Set the background color to pitch black */
            font-family: 'DotGothic16', sans-serif;
        }

        .navbar-brand {
            color: white;
            font-weight: 900;
        }

        .navbar-brand:hover {
            color: white;
        }

        .navbar-nav {
            margin-left: auto;
        }

        .nav-item {
            padding: 0 15px;
        }

        .navbar-toggler {
            border: none;
            outline: none;
        }

        .navbar-toggler-icon {
            background-color: rgb(0, 0, 0);
        }

        @media (max-width: 767px) {
            .navbar-collapse {
                justify-content: center;
            }
        }

        .c-item {
            height: 100%;
        }

        .c-img {
            height: 100%;
            object-fit: cover;
            }
            
          .description-scroll {
            max-height: 10em;
            overflow: auto; 
           }



        .heart-icon i {
            color: black;
            transition: color 0.3s;

        }


        .heart-icon:hover i {
            color: red;
        }


        .cart-icon-link i {
            color: black;
            padding: 15px;
        }

        .cart-icon-link:hover i {
            color: blue;

        }

        .card-body {
            background-color: #e80000;
        }
        
        .table thead th {
            border: 1px solid #dee2e6;
            background-color: #6d6d6d;
            color: #000;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
        }

        .table tbody td {
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
        }

        .cart-img {
            max-width: 80px;
            height: auto;
        }

        .quantity-input {
            width: 100px;
            text-align: center;
        }

        .delete-btn {
            color: #ff0000;
            cursor: pointer;
        }

        .total-price {
            font-weight: bold;
        }
        h1, p{
            font-family: 'DotGothic16', sans-serif;
            color: #f3af02;
        }
    </style>
</head>

  </style>
</head>

<body >
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" id="navbar1">
        <a class="navbar-brand" href="/"><img src="/shop/img/ll.png"></a>
        <div class="container">
      
                <ul class="navbar-nav ml-auto">
                  <li class="nav-item">
                    <div class="dropdown show">
                      <a class="btn dropdown-toggle text-light" role="button" id="dropdownMenuLink" data-toggle="dropdown"
                        aria-expanded="false">
                        Categories
                      </a>
        
                      <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                        <a class="dropdown-item" href="/allproducts">All Products</a>
                        <div class="dropdown-divider"></div>
                        <% categoryData.forEach((category)=>{ %>
                          <a class="dropdown-item" href="/category/desktop-pcs?cat=<%=category._id %>">
                            <%= category.CategoryName %>
                          </a>
                          <% }) %>
        
                      </div>
                    </div>
                  </li>
                    <li class="nav-item">
                        <a class="nav-link" href="wishlist"><i class="fas fa-heart"></i></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="cart"><i class="fas fa-shopping-cart"></i></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-search"></i></a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-user"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                            <% if (user) { %>
                            <a class="dropdown-item" href="account"><%= user.username %></a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="orders">
                              my Orders
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="logout">X Log Out X</a>
                            

                            <% } else { %>
                            <a class="dropdown-item" href="login">Sign In</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="signup">Sign Up</a>
                            <% } %>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
      </nav>
      
        <section class="ftco-section bg-light col-md-12">
            <div class="container" id="cart-container">
              <% if (!user) { %>
                <div class="no-products-container align-items-center">
                  <img class="img" src="/image/0items.webp" alt="No products">
                </div>
                <div class="button-container">
                  <a href="/userlogin">
                    <button class="btn btn-primary btn-lg center-button">Login here</button>
                  </a>
                </div>
              <% } else { %>
                <div class="row">
                  <% cartItems.forEach(function(cartItem) { %>
                    <% if (cartItem.products.length === 0 || !user) { %>
                      <div class="no-products-container align-items-center">
                        <img class="img" src="/image/0items.webp" alt="No products">
                      </div>
                      <% } else { %>
                        <% console.log(cartItem); %>
                      <div class="table-wrap col-md-12">
                        <div class="table-responsive">
                          <table class="table">
                            <thead class="thead-primary">
                              <tr>
                                <th style="padding-right:90px;">Image</th>
                                <th style="padding-right:200px;">Product</th>
                                <th style="padding-right:40px;">Price(₹)</th>
                                <th style="padding-right:110px;">Quantity</th>
                                <th style="padding-right:40px;">Total(₹)</th>
                                <th class="col">Remove</th>
                              </tr>
                            </thead>
                            <tbody>
                                <% cartItem.products.forEach(function(product, index) { %>
                            
                                  
                                <tr>
                                  <td class="image">
                                    <div class="img-container" style="max-width: 150px;">
                                      <a href="/product-details?productId=<%= product.productId %>">
                                        <img src="/uploads/<%= product.productId.productImage[0] %>" class="cart-img" alt="Product Image">
                                    </a>
                                    </div>
                                  </td>
                                  <td>
                                    <div class="product-info">
                                      <span class="product-name"><%= product.productId.productName %></span>
                                      <span class="product-category">(<%= product.productId.productBrand %>)</span>
                                    </div>
                                  </td>
                                  <% if (product.productId.offerPrice !== 0 || product.productId.catofferPrice !== 0) { %>
                                    <td class="price">
                                      <% if (product.productId.offerPrice > 0 && product.productId.catofferPrice > 0) { %>
                                        <% if (product.productId.offerPrice > product.productId.catofferPrice) { %>
                                          <%= product.productId.catofferPrice %> > (<%= product.productId.catofferPercentage%>% off)
                                        <% } else if (product.productId.offerPrice < product.productId.catofferPrice) { %>
                                          <%= product.productId.offerPrice %>(<%= product.productId.offerPercentage %>% off)

                                        <% } %>
                                      <% } else if (product.productId.offerPrice > 0) { %>
                                        <%= product.productId.offerPrice %> <span style="color: #e80000;"> (<%= product.productId.offerPercentage %>% off)</span>

                                      <% } else if (product.productId.catofferPrice > 0) { %>
                                        <%= product.productId.catofferPrice %> <span style="color: #e80000;"> (<%= product.productId.catofferPercentage%>% off)</span>

                                      <% } %>
                                  
                                    </td>
                                  <% } else { %>
                                    <td class="price">
                                      <%= product.productId.productPrice %>
                                    </td>
                                  <% } %>
                                  
                                   
                                  
                                  <td class="quantity">
                                    <% if(product.stock===0) { %>
                                      <p class="text-danger">Out of stock</p>
                                    <% } else { %>
                                      <div class="input-group col-md-12 mb-3">
                                        <span class="input-group-prepend">
                                          <button type="button" class="quantity-left-minus btn" data-product-id="<%= product._id %>" data-prod-id = " <%= product.productId.productId %> " data-orderId="<%= cartItems._id %>">
                                            <i class="fa fa-minus"></i>
                                          </button>
                                        </span>
                                        <input type="text" id="quantity-<%= product._id %>" name="quantity" class="quantity form-control input-number" value="<%= product.quantity %>" min="1" max="<%= product.productId.productQuantity %>" onchange="updateQuantity('<%= product._id %>')">
                                        <span class="input-group-append">
                                          <button type="button" class="quantity-right-plus btn" data-product-id="<%= product._id %>" data-prod-id = "<%= product.productId.productId %> " data-orderId="<%= cartItems._id %>">
                                            <i class="fa fa-plus"></i>
                                          </button>
                                        </span>
                                        <% if(product.productId.productQuantity <=3) {%>
                                             <span style="color: #ff0000;">Only <%= product.productId.productQuantity %> left in stock</span>
                                          <% } %>
                                      </div>
                                    <% } %>
                                  </td>
                                  <!-- <#% if(product.cartOffer === true){ %>
                                    <#% let total = product.offerPrice * product.count; %>
                                    <td class="total">
                                      $<#%= total %>
                                    </td>
                                  <#% }else{ %> -->
                                 
                                    <% let total = product.productId.originalPrice * product.quantity; %>
                                    <td class="total">
                                      $<%= total %>
                                    </td>
                                  <!-- <#% } %> -->
                                  <td class="remove">
                                    <a href="/removeCart?productId=<%= product._id %>&index=<%= index %>" class="btn btn-outline-danger">Remove</a>
                                  </td>
                                </tr>
                              <% }) %>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    <% } %>
                  <% }) %>
                </div>
              <% } %>
            </div>
          </section>
          
          <div class="row justify-content-center bg-light mr-md-1">
            <div class="col-md-4 mb-5 p-5" >
              <a href="/allproducts" class="btn btn-outline-success d-block">Shop more <span class="fa fa-long-arrow-right"></span></a>
            </div>
          </div>
       
          
        </div>
     
        <% cartItems.forEach(function(cartItem) { %>
              <% if (cartItem.products.length !== 0 && user) { %>
              <div class="row justify-content-end bg-light mr-md-1 ">
                <div class="col col-lg-5 col-md-6 mb-md-5 mr-md-5 cart-wrap ftco-animate shadow">
                  <div class="cart-total mb-3 bg-light" style="border: none;">
                  
                    
                    <h3>Cart Totals</h3>
                    <p class="d-flex">
                      <span>Subtotal</span>
                      <span id="total-quantity"></span>
                    </p>
                    <p class="d-flex">
                      <span>Delivery</span>
                      <span id="delivery-charge"></span>
                    </p>
                
                    <hr>
                    <p class="d-flex total-price">
                      <span>Total: ₹</span>
                      <span id="total-price"></span>
                    </p>
                  </div>
       
                  <p class="text-center">
                    <a href="/precheckout" class="btn btn-outline-dark py-3 px-4" id="checkout-btn"><button class="btn btn-muted" onclick="updateQuantityInDatabase()">Proceed to Checkout</button><span id="amount"></span></a>
                  </p>
                </div>
              </div>
              <% } %>
              <% }) %>
              
           


  <!-- Bootstrap JS (optional if you need to add JavaScript functionality) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- <script>
$(document).ready(function () {
    // Plus button click event
    $('.quantity-right-plus').click(function (e) {
        e.preventDefault();
        var $row = $(this).closest('tr');
        var quantityInput = $row.find('.quantity input');
        var quantity = parseInt(quantityInput.val());
        var maxQuantity = parseInt(quantityInput.attr('max'));

        if (quantity < maxQuantity) {
            quantity += 1;
            quantityInput.val(quantity);
            var productId = $(this).data('product-id');       
            // updateTotalAmount(productId); 
            console.log(productId);// Update total price when quantity changes
            updateQuantityInDatabase(productId, quantity)
        }
    });

    // Minus button click event
    $('.quantity-left-minus').click(function (e) {
        e.preventDefault();
        var $row = $(this).closest('tr');
        var quantityInput = $row.find('.quantity input');
        var quantity = parseInt(quantityInput.val());
        console.log(quantity);
        if (quantity > 1) {
            quantity -= 1;
            quantityInput.val(quantity);
            //  updateTotalAmount(productId)
            var productId = $(this).data('product-id');
            updateQuantityInDatabase(productId, quantity);
        }
    });

    function updateQuantityInDatabase(productId, quantity) {
    $.ajax({
      url: '/updateQuantity',
      type: 'POST',
      data: { productId: productId, quantity: quantity },
      success: function (response) {
        console.log('Quantity and price updated in the database');
      },
      error: function (xhr, status, error) {
        console.error('Error updating quantity and price:', error);
      }
    });
  }
  });

  function updateTotalAmount(productId){
  const quantityInput = document.getElementById(`quantity-${productId}`);
  const totalAmountCell = document.getElementById(`totalAmount${productId}`);
  const productPrice = document.getElementById(`price${productId}`);
  const idInput = document.getElementById(`idInput${productId}`);
  var id = idInput.value
  const priceText = productPrice.textContent.trim();
  const price = parseFloat(productPrice.textContent.replace('₹', '').trim()).toFixed(2);

      var quantity = quantityInput.value
      let number = quantityInput.value * price
      number = number.toFixed(2);
      totalAmountCell.textContent = `₹${number}`;
      updateQuantityInDatabase(id, quantity)
  }


    

    

  function extractNumericValue(text) {
        const numericRegex = /[\d.]+/; 
        const matches = text.match(numericRegex);
        if (matches && matches.length > 0) {
            return parseFloat(matches[0]);
        }
        return 0;
    }

  function updateCartTotalPrice() {
        let totalAmount = 0
        const cartRows = document.querySelectorAll(".table tbody tr");

        cartRows.forEach((row) => {
            const totalAmountCell = row.querySelector("[id^='totalAmount']");
            const amount = extractNumericValue(totalAmountCell.innerText);
            totalAmount += amount;
        });
        const cartTotalPrice = document.getElementById("cartTotalPrice");
        cartTotalPrice.textContent = totalAmount.toFixed(2);
        
        $.ajax({
            url:'/getTotalPrice',
            method: 'GET',
            data:{totalAmount: totalAmount },

            success: function(response) {
                console.log(response);
            },
            error: function(error) {
                console.error(error); 
            }
        });

               
    }

  </script>

  <script>
    function updateQuantity(cartId, itemId, newQuantity) {
      const maxStock = parseInt(document.getElementById(`quantity-input-${itemId}`).getAttribute('max'));
  
      if (newQuantity < 1) {
        toastr.error("Quantity cannot be less than 1!", "Error");
        document.getElementById(`quantity-input-${itemId}`).value = 1;
        return;
      }
  
      if (newQuantity > maxStock) {
        toastr.error("Quantity exceeds available stock!", "Error");
        document.getElementById(`quantity-input-${itemId}`).value = maxStock;
        return;
      }  
      toastr.success("Quantity updated successfully!", "Success");
    }
  </script>


<script>
  function updateTotalAmount(productId) {
  const quantityInput = document.getElementById(`quantityInput${productId}`);
  const totalAmountCell = document.getElementById(`totalAmount${productId}`);
  const productPrice = document.getElementById(`price${productId}`);
  const idInput = document.getElementById(`idInput${productId}`);
  var id = idInput.value
  const priceText = productPrice.textContent.trim();
  const price = parseFloat(priceText.replace(' ')).toFixed(2);

      var quantity = quantityInput.value
      let number = quantityInput.value * price
      number = number.toFixed(2);
      totalAmountCell.textContent = `₹${number}`;
      updateQuantityInDatabase(id, quantity)
  }


    const quantityInputs  = document.querySelectorAll('.quantity-input');
    quantityInputs.forEach((input) => {
      input.addEventListener('input', () => {
        const productId = input.id.replace('quantityInput', '');
        updateTotalAmount(productId);
        updateCartTotalPrice();
        console.log("-------------");
      });
    });

    

  function extractNumericValue(text) {
        const numericRegex = /[\d.]+/; 
        const matches = text.match(numericRegex);
        if (matches && matches.length > 0) {
            return parseFloat(matches[0]);
        }
        return 0;
    }

   function updateCartTotalPrice() {
        let totalAmount = 0
        const cartRows = document.querySelectorAll(".table tbody tr");

        cartRows.forEach((row) => {
            const totalAmountCell = row.querySelector("[id^='totalAmount']");
            const amount = extractNumericValue(totalAmountCell.innerText);
            totalAmount += amount;
        });
        const cartTotalPrice = document.getElementById("cartTotalPrice");
        cartTotalPrice.textContent = totalAmount.toFixed(2);
        
        $.ajax({
            url:'/getTotalPrice',
            method: 'GET',
            data:{totalAmount: totalAmount },

            success: function(response) {
                console.log(response);
            },
            error: function(error) {
                console.error(error); 
            }
        });

               
      </script> --
    } -->

    <script>
      $(document).ready(function () {
        $("#couponForm").submit(function (event) {
          event.preventDefault();
          var formData = $(this).serialize();
          console.log(formData);
    
          $.ajax({
            url: "/checkCoupon",
            type: "POST",
            data: formData,
            success: function (response) {
              console.log(response);
              location.reload();
            },
            error: function (error) {
              console.error(error);
            },
          });
        });
      });
    </script>

<script>
	$(document).ready(function () {
  $('.quantity-right-plus').click(function (e) {
    e.preventDefault();
    var $row = $(this).closest('tr');
    var quantityInput = $row.find('.quantity input');
    var quantity = parseInt(quantityInput.val());
	console.log(quantity,"quantity👀👀👀");
    var price = parseFloat($row.find('.price').text());
	console.log(price,"price ✔✔✔");
	var maxQuantity = parseInt(quantityInput.attr('max'));
	console.log(maxQuantity,"max quantity🙌");
    var total = isNaN(quantity) || isNaN(price) ? 0 : (quantity * price)+price;
	console.log(total,"total❤❤❤");
    $row.find('.total').text(total.toFixed(2));
    if(quantity<maxQuantity){
		quantity += 1;
		console.log(quantity,"updated?😊");
        quantityInput.val(quantity);
	} else{
		console.log(quantity,"stop limit reached?😊");
        quantityInput.val(quantity);
	}
	
    // Update the quantity and price in the database
    var productId = $(this).data('product-id');
    updateQuantityInDatabase(productId,quantity);
    calculateSum();
  });

  $('.quantity-left-minus').click(function (e) {
    e.preventDefault();
    var $row = $(this).closest('tr');
    var quantityInput = $row.find('.quantity input');
    var quantity = parseInt(quantityInput.val());
    if (quantity > 1) {
      var price = parseFloat($row.find('.price').text());
      var total = isNaN(quantity) || isNaN(price) ? 0 : (quantity * price)+price;
      $row.find('.total').text(total.toFixed(2));
      quantity -= 1;
      quantityInput.val(quantity);

      // Update the quantity and price in the database
      var productId = $(this).data('product-id');
      updateQuantityInDatabase(productId, quantity);
    }
    calculateSum();
  });

  $('.quantity').on('change', function () {
    var $row = $(this).closest('tr');
    var quantity = parseInt($(this).val());

    // Update the total price
    var price = parseFloat($row.find('.price').text());
    // console.log(price,'😶‍🌫️😶‍🌫️');
    var total = isNaN(quantity) || isNaN(price) ? 0 : (quantity * price)+price;
    $row.find('.total').text(total.toFixed(2));
    var productId = $(this).attr('id').replace('quantity-', '');
    updateQuantityInDatabase(productId, quantity);
    calculateSum();
  });

  function updateQuantityInDatabase(productId, quantity) {
    // let totalPrice = document.getElementById('total-price').textContent , totalAmount: totalPrice
	console.log(quantity,"🌹🌹");
  // console.log(totalPrice,"😶‍🌫️");
    $.ajax({
      url: '/updateQuantity',
      type: 'POST',
      data: { productId: productId, quantity: quantity },
      success: function (response) {
        console.log('Quantity and price updated in the database');
      },
      error: function (xhr, status, error) {
        console.error('Error updating quantity and price:', error);
      }
    });
  }


});


</script>


<!-- -----------------------------------------------------USED TO ADD TOTAL OF THE CART----------------------------------------------------------- -->


<script>
	$(document).ready(function () {
  function calculateSum() {
    var sum = 0;
    var totalQuantity = 0; // Initialize total quantity variable
    $('tbody tr').each(function () {
      var $row = $(this);
      var quantity = parseInt($row.find('.quantity input').val());
      var price = parseFloat($row.find('.price').text());
      var total = isNaN(quantity) || isNaN(price) ? 0 : quantity * price;
      $row.find('.total').text(total.toFixed(2));
      sum += total;
      totalQuantity += quantity; // Accumulate the quantity for each row
    });
    if(totalQuantity === 0){
		$('.row.justify-content-end.bg-light.mr-1').hide();
		$('.table-responsive').hide();
	}
    // Calculate delivery charge based on the total quantity
    var deliveryCharge = sum < 5000 ? 47 : 0;

    // Calculate the total price by adding the sum and delivery charge
    var totalPrice = sum + deliveryCharge;
    console.log(totalPrice,"😜😜😜😜😜");
    const cartId = $('#cart-container').data('cart-id');
     console.log(cartId,'💕'); 
  // Perform an Ajax POST request to send totalPrice to another URL
$.ajax({
    url: 'updateQuantity', // Replace with the actual URL you want to send data to
    type: 'POST', // Use 'POST' method to send data
    data: {
        cartId: cartId,
        totalPrice: totalPrice // Include the data you want to send
    },
    success: function (response) {
        // Handle success response from the server
        console.log('Total price sent successfully:', response);
    },
    error: function (xhr, status, error) {
        // Handle error response from the server
        console.error('Error sending total price:', error);
    }
});



    $('.sum').text(sum.toFixed(2));
    $('#total-quantity').text('₹ '+sum.toFixed(2)); // Update total quantity
    $('#delivery-charge').text('₹ '+deliveryCharge);
    $('#total-price').text(totalPrice.toFixed(2));
	$('#amount').text('  ('+totalQuantity+')' + ' items');
	var checkoutBtn = $('#checkout-btn');
    //used to pass total price as query to /address
    var currentHref = checkoutBtn.attr('href');
    var updatedHref = currentHref.split('?')[0] + '?totalPrice=' + totalPrice.toFixed(2);

    checkoutBtn.attr('href', updatedHref);
  }

  // Call calculateSum() initially to display the total sum
  calculateSum();

  $('.quantity-right-plus, .quantity-left-minus, .quantity').on('click change', function () {
    calculateSum();
  });
 
});

</script>
</body>
</html>
